<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISH NEWS</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="my-favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="my-favicon/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="my-favicon/apple-touch-icon.png">
    <link rel="manifest" href="my-favicon/site.webmanifest">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dropdown.css">
    <link rel="stylesheet" href="css/back-to-top.css">

    <style>
        :root {
            --feed-border: var(--border-color, #333337);
            --feed-hover: rgba(255, 255, 255, 0.03);
            --text-secondary: #8899a6;
        }

        .feed-wrapper {
            max-width: 700px;
            margin: 0 auto;
        }

        .loading {
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        .tweet {
            display: flex;
            padding: 16px;
            border-bottom: 1px solid var(--feed-border);
            transition: background-color 0.2s;
        }

        .tweet:last-child {
            border-bottom: none;
        }

        .tweet:hover {
            background-color: var(--feed-hover);
        }

        .avatar-col {
            margin-right: 12px;
            flex-shrink: 0;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333;
            display: block;
        }

        .content-col {
            flex: 1;
            min-width: 0;
        }

        .tweet-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .display-name {
            font-weight: 700;
            color: var(--text-color, #e0e0e0);
            margin-right: 6px;
            font-size: 1.1em;
        }

        .handle,
        .time {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .handle {
            margin-right: 6px;
        }

        .dot {
            margin: 0 6px;
            color: var(--text-secondary);
        }

        .tweet-text {
            font-size: 1em;
            line-height: 1.6;
            word-wrap: break-word;
            color: var(--text-color, #e0e0e0);
        }

        .tweet-text a {
            color: var(--link-color, #4dd0e1);
            text-decoration: none;
        }

        .tweet-text a:hover {
            text-decoration: underline;
        }

        .tweet-content-html {
            margin-top: 8px;
        }

        .tweet-content-html img,
        .tweet-content-html video {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin-top: 12px;
            border: 1px solid var(--feed-border);
            display: block;
        }
    </style>
</head>

<body>

    <div id="page-background"></div>
    <div id="swimming-images-background" class="swimming-images-container"></div>

    <nav class="main-nav">
        <ul>
            <li><a href="index.html">HOME</a></li>
            <li><a href="daily.html">DAILY VRCHAT</a></li>
            <li class="dropdown">
                <a href="communities.html">COMMUNITIES</a>
                <div class="dropdown-content">
                    <a href="aquarium.html">AQUARIUM</a>
                </div>
            </li>
            <li><a href="database.html">DATABASE</a></li>
            <li><a href="support.html">SUPPORT</a></li>
            <li><a href="news.html" class="active">FISH NEWS</a></li>
            <li><a href="games.html">GAMES</a></li>
            <li><a href="ratfishrace.html">RAT FISH RACE</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>FISH NEWS</h1>

        <div class="feed-wrapper" id="feed">
            <div class="loading" id="loading">Loading updates...</div>
        </div>
    </div>

    <script src="js/prevent-navigation.js"></script>
    <script src="js/script.js"></script>
    <script src="js/swimming-fish.js"></script>
    <script src="js/dropdown.js"></script>
    <script src="js/back-to-top.js"></script>
    <script src="js/lazy-loading.js"></script>

    <script>
        const FEED_URL = 'https://gist.githubusercontent.com/TheZiver/c526bbcc9a1cdd8892186268a4c6b244/raw';

        function timeAgo(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';

            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            const years = Math.floor(seconds / 31536000);
            if (years >= 1) return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });

            const days = Math.floor(seconds / 86400);
            if (days >= 2) return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            if (days === 1) return '1d';

            const hours = Math.floor(seconds / 3600);
            if (hours >= 1) return hours + 'h';

            const minutes = Math.floor(seconds / 60);
            if (minutes >= 1) return minutes + 'm';

            return 'Just now';
        }

        function processContent(html, media) {
            if (!html) html = '';

            var processedHtml = html;

            // 1) Append media from the JSON `media` array (images, direct mp4, etc.)
            if (Array.isArray(media)) {
                for (var i = 0; i < media.length; i++) {
                    var m = media[i];
                    if (!m || !m.url) continue;

                    var safeUrl = m.url.replace(/&amp;/g, '&');

                    if (m.type === 'image') {
                        processedHtml +=
                            '<br><img src="' + safeUrl + '" alt="Tweet image">';
                    } else if (m.type === 'video') {
                        processedHtml +=
                            '<br><video controls playsinline preload="metadata">' +
                            '<source src="' + safeUrl + '" type="video/mp4">' +
                            'Your browser does not support the video tag.' +
                            '</video>';
                    }
                }
            }

            // 2) Auto-embed YouTube links that appear in the text/html
            var youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/gi;
            var matches = [];
            var match;

            while ((match = youtubeRegex.exec(html)) !== null) {
                matches.push(match);
            }

            var uniqueVideos = {};

            for (var j = 0; j < matches.length; j++) {
                var videoId = matches[j][1];
                if (!uniqueVideos[videoId]) {
                    uniqueVideos[videoId] = true;
                    processedHtml +=
                        '<div class="video-container">' +
                        '<iframe src="https://www.youtube.com/embed/' + videoId + '" ' +
                        'title="YouTube video player" ' +
                        'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
                        'allowfullscreen></iframe>' +
                        '</div>';
                }
            }

            return processedHtml;
        }

        function linkify(element) {
            var walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            var nodes = [];
            var node;

            while ((node = walker.nextNode())) {
                nodes.push(node);
            }

            var urlRegex = /(https?:\/\/[^\s]+)/g;

            for (var i = 0; i < nodes.length; i++) {
                var textNode = nodes[i];

                if (!textNode.parentNode ||
                    textNode.parentNode.closest('a') ||
                    textNode.parentNode.tagName === 'SCRIPT' ||
                    textNode.parentNode.tagName === 'STYLE') {
                    continue;
                }

                var text = textNode.nodeValue;
                if (!urlRegex.test(text)) {
                    urlRegex.lastIndex = 0;
                    continue;
                }

                var frag = document.createDocumentFragment();
                var lastIndex = 0;
                var m;
                urlRegex.lastIndex = 0;

                while ((m = urlRegex.exec(text)) !== null) {
                    var url = m[0];

                    while (url.length && /[.,;!\])]/.test(url.charAt(url.length - 1))) {
                        url = url.slice(0, -1);
                    }

                    var pre = text.substring(lastIndex, m.index);
                    if (pre) frag.appendChild(document.createTextNode(pre));

                    var a = document.createElement('a');
                    a.href = url;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    a.textContent = url;
                    a.onclick = function (e) { e.stopPropagation(); };
                    frag.appendChild(a);

                    lastIndex = m.index + m[0].length;
                }

                var rest = text.substring(lastIndex);
                if (rest) frag.appendChild(document.createTextNode(rest));

                textNode.parentNode.replaceChild(frag, textNode);
            }
        }

        function renderTweets(tweets) {
            var container = document.getElementById('feed');
            var loading = document.getElementById('loading');
            if (loading && loading.parentNode) {
                loading.parentNode.removeChild(loading);
            }

            for (var i = 0; i < tweets.length; i++) {
                var tweet = tweets[i];
                var timeString = timeAgo(tweet.dateObj);
                var processedContent = processContent(tweet.contentHtml, tweet.media);

                var article = document.createElement('article');
                article.className = 'tweet';
                article.style.cursor = 'pointer';

                article.onclick = function (t) {
                    return function (e) {
                        if (e.target && (e.target.closest('a') || e.target.tagName === 'IFRAME')) {
                            e.stopPropagation();
                            return;
                        }
                        if (t.link) {
                            window.open(t.link, '_blank');
                        }
                    };
                }(tweet);

                var html = '' +
                    '<div class="avatar-col">' +
                    '<img src="' + tweet.avatar + '" alt="' + tweet.handle + '" class="avatar" ' +
                    'onerror="this.onerror=null;this.src=\'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png\';">' +
                    '</div>' +
                    '<div class="content-col">' +
                    '<div class="tweet-header">' +
                    '<span class="display-name">' + tweet.displayName + '</span>' +
                    '<span class="handle">' + tweet.handle + '</span>' +
                    '<span class="dot">Â·</span>' +
                    '<span class="time">' + timeString + '</span>' +
                    '</div>' +
                    '<div class="tweet-text">' +
                    '<div class="tweet-content-html">' + processedContent + '</div>' +
                    '</div>' +
                    '</div>';

                article.innerHTML = html;

                var contentDiv = article.querySelector('.tweet-content-html');
                if (contentDiv) {
                    linkify(contentDiv);
                }

                container.appendChild(article);
            }
        }

        async function fetchAndRenderFeed() {
            try {
                var response = await fetch(FEED_URL, { cache: 'no-store' });
                if (!response.ok) throw new Error('Failed to fetch feed');
                var data = await response.json();

                var accountDefaults = {
                    TheRoseFish: 'https://pbs.twimg.com/profile_images/1988644928881127424/ql-Ds2HI.jpg',
                    TheZiver: 'https://pbs.twimg.com/profile_images/1764321982638632960/8DuUQtQP.jpg',
                    RandumUwU: 'https://pbs.twimg.com/profile_images/1919424934293692416/MPA6JH94.jpg'
                };

                var allTweets = [];
                if (data && Array.isArray(data.items)) {
                    for (var i = 0; i < data.items.length; i++) {
                        var item = data.items[i];
                        var displayName = item.author || 'TheRoseFish';
                        var handle = '@' + displayName;
                        var avatarUrl = accountDefaults[displayName] ||
                            item.author_avatar ||
                            'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';

                        allTweets.push({
                            displayName: displayName,
                            handle: handle,
                            avatar: avatarUrl,
                            dateObj: new Date(item.date),
                            contentHtml: item.html_content || '',
                            media: Array.isArray(item.media) ? item.media : [],
                            link: item.url || ''
                        });
                    }
                }

                allTweets.sort(function (a, b) { return b.dateObj - a.dateObj; });
                renderTweets(allTweets);
            } catch (err) {
                var loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = '<p style="color:#ff6b6b; text-align:center">Error loading feed: ' + err.message + '</p>';
                }
                console.error(err);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            fetchAndRenderFeed();
        });
    </script>

</body>

</html>