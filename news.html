<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISH NEWS</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="my-favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="my-favicon/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="my-favicon/apple-touch-icon.png">
    <link rel="manifest" href="my-favicon/site.webmanifest">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dropdown.css">
    <link rel="stylesheet" href="css/back-to-top.css">

    <style>
        /* Feed Specific Styles - Adapted for Dark Theme */
        :root {
            --feed-border: var(--border-color, #333337);
            --feed-hover: rgba(255, 255, 255, 0.03);
            --text-secondary: #8899a6;
        }

        .feed-wrapper {
            max-width: 700px;
            margin: 0 auto;
        }

        .loading {
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Tweet Card */
        .tweet {
            display: flex;
            padding: 16px;
            border-bottom: 1px solid var(--feed-border);
            transition: background-color 0.2s;
        }

        .tweet:last-child {
            border-bottom: none;
        }

        .tweet:hover {
            background-color: var(--feed-hover);
        }

        .avatar-col {
            margin-right: 12px;
            flex-shrink: 0;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333;
        }

        .content-col {
            flex: 1;
            min-width: 0;
        }

        /* Tweet Header */
        .tweet-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .display-name {
            font-weight: 700;
            color: var(--text-color, #e0e0e0);
            margin-right: 6px;
            font-size: 1.1em;
        }

        .handle,
        .time {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .handle {
            margin-right: 6px;
        }

        .dot {
            margin: 0 6px;
            color: var(--text-secondary);
        }

        /* Tweet Body & Media */
        .tweet-text {
            font-size: 1em;
            line-height: 1.6;
            word-wrap: break-word;
            color: var(--text-color, #e0e0e0);
        }

        .tweet-text a {
            color: var(--link-color, #4dd0e1);
            text-decoration: none;
        }

        .tweet-text a:hover {
            text-decoration: underline;
        }

        .tweet-content-html {
            margin-top: 8px;
        }

        .tweet-content-html img,
        .tweet-content-html video {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin-top: 12px;
            border: 1px solid var(--feed-border);
            display: block;
        }
    </style>
</head>

<body>

    <div id="page-background"></div>

    <!-- Background container for swimming community images -->
    <div id="swimming-images-background" class="swimming-images-container"></div>

    <nav class="main-nav">
        <ul>
            <li><a href="index.html">HOME</a></li>
            <li><a href="daily.html">DAILY VRCHAT</a></li>
            <li class="dropdown">
                <a href="communities.html">COMMUNITIES</a>
                <div class="dropdown-content">
                    <a href="aquarium.html">AQUARIUM</a>
                </div>
            </li>
            <li><a href="database.html">DATABASE</a></li>
            <li><a href="support.html">SUPPORT</a></li>
            <li><a href="news.html" class="active">FISH NEWS</a></li>
            <li><a href="games.html">GAMES</a></li>
            <li><a href="ratfishrace.html">RAT FISH RACE</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>FISH NEWS</h1>

        <div class="feed-wrapper" id="feed">
            <div class="loading" id="loading">Loading updates...</div>
        </div>
    </div>

    <script src="js/prevent-navigation.js"></script>
    <script src="js/script.js"></script>
    <script src="js/swimming-fish.js"></script>
    <script src="js/dropdown.js"></script>
    <script src="js/back-to-top.js"></script>
    <script src="js/lazy-loading.js"></script>

    <script>
        const FEED_URL = 'https://gist.githubusercontent.com/TheZiver/c526bbcc9a1cdd8892186268a4c6b244/raw';

        // Helper: Convert date to relative time
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const interval = Math.floor(seconds / 31536000);

            if (interval > 1) return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });

            const day = Math.floor(seconds / 86400);
            if (day > 1) return date.toLocaleDateString([], { month: 'short', day: 'numeric' });

            const hour = Math.floor(seconds / 3600);
            if (hour >= 1) return hour + "h";

            const minute = Math.floor(seconds / 60);
            if (minute >= 1) return minute + "m";

            return "Just now";
        }

        async function fetchAndRenderFeed() {
            try {
                const response = await fetch(FEED_URL);
                if (!response.ok) throw new Error("Failed to fetch feed");
                const data = await response.json();

                let allTweets = [];

                if (data.items && Array.isArray(data.items)) {
                    data.items.forEach(item => {
                        const displayName = item.author || 'TheRoseFish';
                        const handle = `@${displayName}`;
                        const avatarUrl = item.author_avatar || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';

                        allTweets.push({
                            displayName: displayName,
                            handle: handle,
                            avatar: avatarUrl,
                            dateObj: new Date(item.date),
                            contentHtml: item.html_content,
                            link: item.url
                        });
                    });
                }

                allTweets.sort((a, b) => b.dateObj - a.dateObj);
                renderTweets(allTweets);

            } catch (error) {
                document.getElementById('loading').innerHTML = `<p style="color:#ff6b6b; text-align:center">Error loading feed: ${error.message}</p>`;
                console.error(error);
            }
        }

        function processContent(html) {
            // Regex to find YouTube video IDs
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/gi;
            const matches = [...html.matchAll(youtubeRegex)];

            let processedHtml = html;
            let uniqueVideos = new Set();

            if (matches.length > 0) {
                matches.forEach(match => {
                    const videoId = match[1];
                    if (!uniqueVideos.has(videoId)) {
                        uniqueVideos.add(videoId);
                        const embedCode = `
                            <div class="video-container" style="margin-top: 10px; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; border: 1px solid var(--feed-border);">
                                <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" 
                                    src="https://www.youtube.com/embed/${videoId}" 
                                    title="YouTube video player" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                                </iframe>
                            </div>`;
                        processedHtml += embedCode;
                    }
                });
            }
            return processedHtml;
        }

        function linkify(element) {
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            const nodes = [];
            while (walker.nextNode()) nodes.push(walker.currentNode);

            // Regex to find URLs
            const urlRegex = /(https?:\/\/[^\s]+)/g;

            nodes.forEach(node => {
                // Skip if already inside a link or script/style
                if (node.parentNode.closest('a') || node.parentNode.tagName === 'SCRIPT' || node.parentNode.tagName === 'STYLE') return;

                const text = node.nodeValue;
                if (text.match(urlRegex)) {
                    const fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    let match;

                    // Reset regex state
                    urlRegex.lastIndex = 0;

                    while ((match = urlRegex.exec(text)) !== null) {
                        let url = match[0];

                        // Trim trailing punctuation
                        while (['.', ',', ';', '!', ')', ']'].includes(url.slice(-1))) {
                            url = url.slice(0, -1);
                        }

                        const preText = text.substring(lastIndex, match.index);
                        fragment.appendChild(document.createTextNode(preText));

                        const a = document.createElement('a');
                        a.href = url;
                        a.target = '_blank';
                        a.textContent = url;
                        a.onclick = (e) => e.stopPropagation();
                        fragment.appendChild(a);

                        lastIndex = match.index + url.length;
                    }

                    fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                    node.parentNode.replaceChild(fragment, node);
                }
            });
        }

        function renderTweets(tweets) {
            const container = document.getElementById('feed');
            const loading = document.getElementById('loading');
            if (loading) loading.remove();

            tweets.forEach(tweet => {
                const timeString = timeAgo(tweet.dateObj);
                const processedContent = processContent(tweet.contentHtml);

                const article = document.createElement('article');
                article.className = 'tweet';
                article.onclick = (e) => {
                    // Don't trigger if clicking a link or iframe inside
                    if (!e.target.closest('a') && e.target.tagName !== 'IFRAME') {
                        window.open(tweet.link, '_blank');
                    }
                };
                article.style.cursor = 'pointer';

                article.innerHTML = `
                <div class="avatar-col">
                    <img src="${tweet.avatar}" alt="${tweet.handle}" class="avatar" onerror="this.src='https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png'">
                </div>
                <div class="content-col">
                    <div class="tweet-header">
                        <span class="display-name">${tweet.displayName}</span>
                        <span class="handle">${tweet.handle}</span>
                        <span class="dot">Â·</span>
                        <span class="time">${timeString}</span>
                    </div>
                    
                    <div class="tweet-text">
                        <div class="tweet-content-html">${processedContent}</div>
                    </div>
                </div>
            `;

                // Make links clickable in the content
                const contentDiv = article.querySelector('.tweet-content-html');
                if (contentDiv) {
                    linkify(contentDiv);
                }

                container.appendChild(article);
            });
        }

        document.addEventListener('DOMContentLoaded', fetchAndRenderFeed);
    </script>

</body>

</html>